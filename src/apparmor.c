/*
 * Special apparmor handling
 *
 * Copyright (C) 2025 William Horvath
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU Lesser General Public
 * License as published by the Free Software Foundation; either
 * version 2.1 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this library; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA
 */

#include "apparmor.h"
#include "util.h"

#define APPARMOR_DIR "/etc/apparmor.d"
#define APPARMOR_PROFILE_NAME "bwrap-userns-restrict-" PROG_NAME
#define APPARMOR_PROFILE_PATH APPARMOR_DIR "/" APPARMOR_PROFILE_NAME

/*
 * Data from the /usr/share/apparmor/extra-profiles/bwrap-userns-restrict file from
 * http://ftp.us.debian.org/debian/pool/main/a/apparmor/apparmor-profiles_4.1.0~beta5-3_all.deb
 *
 * Allows pressure-vessel to run with AppArmor enabled, i.e. on Ubuntu 24+ or Debian
 * umu-launcher also installs this as part of its .deb package
 */
static const unsigned char bwrap_userns_restrict[] = {
    0x61, 0x62, 0x69, 0x20, 0x3c, 0x61, 0x62, 0x69, 0x2f, 0x34, 0x2e, 0x30, 0x3e, 0x2c, 0x0a, 0x69, 0x6e, 0x63, 0x6c,
    0x75, 0x64, 0x65, 0x20, 0x3c, 0x74, 0x75, 0x6e, 0x61, 0x62, 0x6c, 0x65, 0x73, 0x2f, 0x67, 0x6c, 0x6f, 0x62, 0x61,
    0x6c, 0x3e, 0x0a, 0x70, 0x72, 0x6f, 0x66, 0x69, 0x6c, 0x65, 0x20, 0x62, 0x77, 0x72, 0x61, 0x70, 0x20, 0x2f, 0x75,
    0x73, 0x72, 0x2f, 0x62, 0x69, 0x6e, 0x2f, 0x62, 0x77, 0x72, 0x61, 0x70, 0x20, 0x66, 0x6c, 0x61, 0x67, 0x73, 0x3d,
    0x28, 0x61, 0x74, 0x74, 0x61, 0x63, 0x68, 0x5f, 0x64, 0x69, 0x73, 0x63, 0x6f, 0x6e, 0x6e, 0x65, 0x63, 0x74, 0x65,
    0x64, 0x2c, 0x6d, 0x65, 0x64, 0x69, 0x61, 0x74, 0x65, 0x5f, 0x64, 0x65, 0x6c, 0x65, 0x74, 0x65, 0x64, 0x29, 0x20,
    0x7b, 0x0a, 0x61, 0x6c, 0x6c, 0x6f, 0x77, 0x20, 0x63, 0x61, 0x70, 0x61, 0x62, 0x69, 0x6c, 0x69, 0x74, 0x79, 0x2c,
    0x0a, 0x61, 0x6c, 0x6c, 0x6f, 0x77, 0x20, 0x66, 0x69, 0x6c, 0x65, 0x20, 0x72, 0x77, 0x6c, 0x6b, 0x6d, 0x20, 0x2f,
    0x7b, 0x2a, 0x2a, 0x2c, 0x7d, 0x2c, 0x0a, 0x61, 0x6c, 0x6c, 0x6f, 0x77, 0x20, 0x6e, 0x65, 0x74, 0x77, 0x6f, 0x72,
    0x6b, 0x2c, 0x0a, 0x61, 0x6c, 0x6c, 0x6f, 0x77, 0x20, 0x75, 0x6e, 0x69, 0x78, 0x2c, 0x0a, 0x61, 0x6c, 0x6c, 0x6f,
    0x77, 0x20, 0x70, 0x74, 0x72, 0x61, 0x63, 0x65, 0x2c, 0x0a, 0x61, 0x6c, 0x6c, 0x6f, 0x77, 0x20, 0x73, 0x69, 0x67,
    0x6e, 0x61, 0x6c, 0x2c, 0x0a, 0x61, 0x6c, 0x6c, 0x6f, 0x77, 0x20, 0x6d, 0x71, 0x75, 0x65, 0x75, 0x65, 0x2c, 0x0a,
    0x61, 0x6c, 0x6c, 0x6f, 0x77, 0x20, 0x69, 0x6f, 0x5f, 0x75, 0x72, 0x69, 0x6e, 0x67, 0x2c, 0x0a, 0x61, 0x6c, 0x6c,
    0x6f, 0x77, 0x20, 0x75, 0x73, 0x65, 0x72, 0x6e, 0x73, 0x2c, 0x0a, 0x61, 0x6c, 0x6c, 0x6f, 0x77, 0x20, 0x6d, 0x6f,
    0x75, 0x6e, 0x74, 0x2c, 0x0a, 0x61, 0x6c, 0x6c, 0x6f, 0x77, 0x20, 0x75, 0x6d, 0x6f, 0x75, 0x6e, 0x74, 0x2c, 0x0a,
    0x61, 0x6c, 0x6c, 0x6f, 0x77, 0x20, 0x70, 0x69, 0x76, 0x6f, 0x74, 0x5f, 0x72, 0x6f, 0x6f, 0x74, 0x2c, 0x0a, 0x61,
    0x6c, 0x6c, 0x6f, 0x77, 0x20, 0x64, 0x62, 0x75, 0x73, 0x2c, 0x0a, 0x61, 0x6c, 0x6c, 0x6f, 0x77, 0x20, 0x70, 0x69,
    0x78, 0x20, 0x2f, 0x2a, 0x2a, 0x20, 0x2d, 0x3e, 0x20, 0x26, 0x62, 0x77, 0x72, 0x61, 0x70, 0x2f, 0x2f, 0x26, 0x75,
    0x6e, 0x70, 0x72, 0x69, 0x76, 0x5f, 0x62, 0x77, 0x72, 0x61, 0x70, 0x2c, 0x0a, 0x69, 0x6e, 0x63, 0x6c, 0x75, 0x64,
    0x65, 0x20, 0x69, 0x66, 0x20, 0x65, 0x78, 0x69, 0x73, 0x74, 0x73, 0x20, 0x3c, 0x6c, 0x6f, 0x63, 0x61, 0x6c, 0x2f,
    0x62, 0x77, 0x72, 0x61, 0x70, 0x2d, 0x75, 0x73, 0x65, 0x72, 0x6e, 0x73, 0x2d, 0x72, 0x65, 0x73, 0x74, 0x72, 0x69,
    0x63, 0x74, 0x3e, 0x0a, 0x7d, 0x0a, 0x70, 0x72, 0x6f, 0x66, 0x69, 0x6c, 0x65, 0x20, 0x75, 0x6e, 0x70, 0x72, 0x69,
    0x76, 0x5f, 0x62, 0x77, 0x72, 0x61, 0x70, 0x20, 0x66, 0x6c, 0x61, 0x67, 0x73, 0x3d, 0x28, 0x61, 0x74, 0x74, 0x61,
    0x63, 0x68, 0x5f, 0x64, 0x69, 0x73, 0x63, 0x6f, 0x6e, 0x6e, 0x65, 0x63, 0x74, 0x65, 0x64, 0x2c, 0x6d, 0x65, 0x64,
    0x69, 0x61, 0x74, 0x65, 0x5f, 0x64, 0x65, 0x6c, 0x65, 0x74, 0x65, 0x64, 0x29, 0x20, 0x7b, 0x0a, 0x61, 0x6c, 0x6c,
    0x6f, 0x77, 0x20, 0x66, 0x69, 0x6c, 0x65, 0x20, 0x72, 0x77, 0x6c, 0x6b, 0x6d, 0x20, 0x2f, 0x7b, 0x2a, 0x2a, 0x2c,
    0x7d, 0x2c, 0x0a, 0x61, 0x6c, 0x6c, 0x6f, 0x77, 0x20, 0x6e, 0x65, 0x74, 0x77, 0x6f, 0x72, 0x6b, 0x2c, 0x0a, 0x61,
    0x6c, 0x6c, 0x6f, 0x77, 0x20, 0x75, 0x6e, 0x69, 0x78, 0x2c, 0x0a, 0x61, 0x6c, 0x6c, 0x6f, 0x77, 0x20, 0x70, 0x74,
    0x72, 0x61, 0x63, 0x65, 0x2c, 0x0a, 0x61, 0x6c, 0x6c, 0x6f, 0x77, 0x20, 0x73, 0x69, 0x67, 0x6e, 0x61, 0x6c, 0x2c,
    0x0a, 0x61, 0x6c, 0x6c, 0x6f, 0x77, 0x20, 0x6d, 0x71, 0x75, 0x65, 0x75, 0x65, 0x2c, 0x0a, 0x61, 0x6c, 0x6c, 0x6f,
    0x77, 0x20, 0x69, 0x6f, 0x5f, 0x75, 0x72, 0x69, 0x6e, 0x67, 0x2c, 0x0a, 0x61, 0x6c, 0x6c, 0x6f, 0x77, 0x20, 0x75,
    0x73, 0x65, 0x72, 0x6e, 0x73, 0x2c, 0x0a, 0x61, 0x6c, 0x6c, 0x6f, 0x77, 0x20, 0x6d, 0x6f, 0x75, 0x6e, 0x74, 0x2c,
    0x0a, 0x61, 0x6c, 0x6c, 0x6f, 0x77, 0x20, 0x75, 0x6d, 0x6f, 0x75, 0x6e, 0x74, 0x2c, 0x0a, 0x61, 0x6c, 0x6c, 0x6f,
    0x77, 0x20, 0x70, 0x69, 0x76, 0x6f, 0x74, 0x5f, 0x72, 0x6f, 0x6f, 0x74, 0x2c, 0x0a, 0x61, 0x6c, 0x6c, 0x6f, 0x77,
    0x20, 0x64, 0x62, 0x75, 0x73, 0x2c, 0x0a, 0x61, 0x6c, 0x6c, 0x6f, 0x77, 0x20, 0x70, 0x69, 0x78, 0x20, 0x2f, 0x2a,
    0x2a, 0x20, 0x2d, 0x3e, 0x20, 0x26, 0x75, 0x6e, 0x70, 0x72, 0x69, 0x76, 0x5f, 0x62, 0x77, 0x72, 0x61, 0x70, 0x2c,
    0x0a, 0x61, 0x75, 0x64, 0x69, 0x74, 0x20, 0x64, 0x65, 0x6e, 0x79, 0x20, 0x63, 0x61, 0x70, 0x61, 0x62, 0x69, 0x6c,
    0x69, 0x74, 0x79, 0x2c, 0x0a, 0x69, 0x6e, 0x63, 0x6c, 0x75, 0x64, 0x65, 0x20, 0x69, 0x66, 0x20, 0x65, 0x78, 0x69,
    0x73, 0x74, 0x73, 0x20, 0x3c, 0x6c, 0x6f, 0x63, 0x61, 0x6c, 0x2f, 0x75, 0x6e, 0x70, 0x72, 0x69, 0x76, 0x5f, 0x62,
    0x77, 0x72, 0x61, 0x70, 0x3e, 0x0a, 0x7d, 0x0a};
static const unsigned int bwrap_userns_restrict_len = 749;

/* Test if the container works by running a simple command inside it */
static int test_container(const char *entry_point) {
    char *test_cmd = NULL;
    char *stdout_file = NULL;
    char *stderr_file = NULL;
    FILE *stderr_fp = NULL;
    int ret = 0;
    int apparmor_issue = 0;
    char error_buf[BUFFER_SIZE] = {0};

    join_paths(stdout_file, get_yawl_dir(), "test_stdout.tmp");
    join_paths(stderr_file, get_yawl_dir(), "test_stderr.tmp");

    append_sep(test_cmd, " ", entry_point, "--verb=waitforexitandrun", "--", "/bin/true", ">", stdout_file, "2>",
               stderr_file);

    /* Run the test */
    ret = system(test_cmd);

    /* Check stderr for AppArmor issues */
    stderr_fp = fopen(stderr_file, "r");
    if (stderr_fp) {
        while (fgets(error_buf, sizeof(error_buf), stderr_fp)) {
            if (strstr(error_buf, "bwrap") && strstr(error_buf, "Permission denied")) {
                apparmor_issue = 1;
                break;
            }
        }
        fclose(stderr_fp);
    }

    /* Clean up temporary files */
    unlink(stdout_file);
    unlink(stderr_file);

    free(test_cmd);
    free(stdout_file);
    free(stderr_file);

    if (ret != 0 || apparmor_issue)
        return -1;

    return 0;
}

/* Write the AppArmor profile to a temporary file */
static int write_temp_apparmor_profile(char **temp_path) {
    FILE *fp = NULL;

    /* Create a temporary file in the yawl directory */
    join_paths(*temp_path, get_yawl_dir(), APPARMOR_PROFILE_NAME ".tmp");

    fp = fopen(*temp_path, "wb");
    if (!fp) {
        fprintf(stderr, "Error: Failed to create temporary AppArmor profile: %s\n", strerror(errno));
        return -1;
    }

    if (fwrite(bwrap_userns_restrict, 1, bwrap_userns_restrict_len, fp) != bwrap_userns_restrict_len) {
        fprintf(stderr, "Error: Failed to write AppArmor profile data: %s\n", strerror(errno));
        fclose(fp);
        unlink(*temp_path);
        return -1;
    }

    fclose(fp);
    return 0;
}

/* Install the AppArmor profile using pkexec */
static int install_apparmor_profile(void) {
    struct stat st;
    char *temp_profile_path = NULL;
    char *install_cmd = NULL;
    int ret = 0;

    /* Write the profile to a temporary file */
    if (stat(APPARMOR_PROFILE_PATH, &st) != 0) {
        if (write_temp_apparmor_profile(&temp_profile_path) != 0) {
            free(temp_profile_path);
            return -1;
        }
    }

    printf("Installing AppArmor profile to enable container functionality...\n");
    printf("Please enter your password when prompted. This just installs a file to\n");
    printf("    /etc/apparmor.d/, which gives enough permissions to the pressure-vessel container\n");
    printf("    to function properly. If you don't trust me, follow this guide to install it manually:\n");
    printf("    https://github.com/ocaml/opam/issues/5968#issuecomment-2151748424\n");

    /* Create the command to install the profile */
    append_sep(install_cmd, " ", "pkexec", "sh", "-c", "'mkdir -p " APPARMOR_DIR " && cp", temp_profile_path,
               APPARMOR_PROFILE_PATH " && chmod 644 " APPARMOR_PROFILE_PATH " && "
                                     "apparmor_parser -r -W " APPARMOR_PROFILE_PATH "'");

    ret = system(install_cmd);
    if (ret != 0) {
        fprintf(stderr, "Error: Failed to install AppArmor profile (exit code %d).\n", WEXITSTATUS(ret));
        ret = -1;
    } else {
        printf("AppArmor profile installed successfully.\n");
        ret = 0;
    }

    unlink(temp_profile_path);
    free(temp_profile_path);
    free(install_cmd);

    return ret;
}

int handle_apparmor(const char *entry_point) {
    int container_test_result = test_container(entry_point);

    if (container_test_result == 0)
        return 0;

    printf("Detected AppArmor restrictions preventing container operation.\n");

    /* Try to install the AppArmor profile */
    if (install_apparmor_profile() != 0) {
        fprintf(stderr, "Warning: Failed to install AppArmor profile. Container may not work correctly.\n");
        fprintf(stderr, "Please follow this guide to manually install the AppArmor profile:\n");
        fprintf(stderr, "   https://github.com/ocaml/opam/issues/5968#issuecomment-2151748424\n");
        return -1;
    }

    /* Test the container again after installing the profile */
    if (test_container(entry_point) != 0) {
        fprintf(stderr, "Warning: Container still not working after AppArmor profile installation.\n");
        fprintf(stderr, "You may need to restart the system for AppArmor changes to take effect.\n");
        return -1;
    }

    return 0;
}
